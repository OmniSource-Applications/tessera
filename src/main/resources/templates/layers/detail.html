<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<th:block th:fragment="content">

    <!-- Breadcrumb -->
    <nav class="mb-6 text-sm text-muted">
        <a th:href="@{/workspaces}" class="hover:text-foreground transition-colors">Workspaces</a>
        <span class="mx-1.5">/</span>
        <a th:href="@{/workspaces/{ws}(ws=${workspace})}"
           th:text="${workspace}" class="hover:text-foreground transition-colors">ws</a>
        <span class="mx-1.5">/</span>
        <a th:href="@{/workspaces/{ws}/datastores/{ds}(ws=${workspace}, ds=${datastore})}"
           th:text="${datastore}" class="hover:text-foreground transition-colors">ds</a>
        <span class="mx-1.5">/</span>
        <a th:href="@{/workspaces/{ws}/datastores/{ds}/layers(ws=${workspace}, ds=${datastore})}"
           class="hover:text-foreground transition-colors">Layers</a>
        <span class="mx-1.5">/</span>
        <span class="text-foreground font-medium" th:text="${layer.layer().layer()}">layer</span>
    </nav>

    <!-- Flash messages -->
    <div th:if="${success}"
         class="mb-6 rounded-lg bg-success/10 border border-success/20 px-4 py-3 text-sm text-success">
        <span th:text="${success}">Success</span>
    </div>
    <div th:if="${error}"
         class="mb-6 rounded-lg bg-danger/10 border border-danger/20 px-4 py-3 text-sm text-danger">
        <span th:text="${error}">Error</span>
    </div>

    <!-- Status + Manual sync -->
    <div class="mb-6 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium"
                  th:classappend="${layer.status() == 'ACTIVE'} ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'"
                  th:text="${layer.status()}">ACTIVE</span>
            <span class="text-sm text-muted">
                Source:
                <span class="text-foreground" th:text="${layer.sourceSchema() + '.' + layer.sourceTable()}">public.table</span>
            </span>
        </div>
        <form th:action="@{/workspaces/{ws}/datastores/{ds}/layers/{l}/sync(ws=${workspace}, ds=${datastore}, l=${layer.layer().layer()})}"
              method="post">
            <button type="submit"
                    class="inline-flex items-center gap-2 rounded-lg bg-primary px-4 py-2.5 text-sm font-medium
                           text-primary-foreground hover:bg-primary-hover transition-all shadow-sm">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                          d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182"/>
                </svg>
                Sync Now
            </button>
        </form>
    </div>

    <!-- Sync status card -->
    <div th:if="${syncMeta != null}" class="mb-6 bg-surface border border-border rounded-xl p-5">
        <div class="flex items-center justify-between mb-3">
            <h3 class="text-sm font-semibold text-foreground">Sync Status</h3>
            <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium bg-primary/10 text-primary"
                  th:text="${syncMeta.get('status')}">SYNCED</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm">
            <div>
                <p class="text-xs text-muted uppercase tracking-wide">Total Ingested</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('totalIngested')}">0</p>
            </div>
            <div>
                <p class="text-xs text-muted uppercase tracking-wide">Last Batch</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('lastBatchSize')}">0</p>
            </div>
            <div>
                <p class="text-xs text-muted uppercase tracking-wide">Last Mode</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('lastMode')}">—</p>
            </div>
            <div>
                <p class="text-xs text-muted uppercase tracking-wide">Syncs Run</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('syncCount')}">0</p>
            </div>
            <div>
                <p class="text-xs text-muted uppercase tracking-wide">H3 Resolutions</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('h3Resolutions')}">—</p>
            </div>
            <div class="sm:col-span-3">
                <p class="text-xs text-muted uppercase tracking-wide">Last Synced</p>
                <p class="mt-0.5 font-semibold text-foreground"
                   th:text="${syncMeta.get('lastSync')}">—</p>
            </div>
        </div>
    </div>

    <!-- Auto-sync configuration -->
    <div class="mb-8 bg-surface border border-border rounded-xl p-5">
        <h3 class="text-sm font-semibold text-foreground mb-4">Auto-Sync Configuration</h3>

        <form th:action="@{/workspaces/{ws}/datastores/{ds}/layers/{l}/sync/config(ws=${workspace}, ds=${datastore}, l=${layer.layer().layer()})}"
              method="post"
              class="space-y-4">

            <!-- Enable toggle -->
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-foreground">Enable Auto-Sync</p>
                    <p class="text-xs text-muted mt-0.5">Periodically poll the source for new data</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" name="enabled" value="true" class="sr-only peer"
                           th:checked="${layer.syncConfig() != null and layer.syncConfig().enabled()}">
                    <div class="w-11 h-6 rounded-full bg-border peer-checked:bg-primary
                                after:content-[''] after:absolute after:top-[2px] after:start-[2px]
                                after:bg-white after:rounded-full after:h-5 after:w-5
                                after:transition-all peer-checked:after:translate-x-full
                                transition-colors"></div>
                </label>
            </div>

            <!-- Poll interval -->
            <div>
                <label for="pollInterval" class="block text-sm font-medium text-foreground mb-1.5">
                    Poll Interval (seconds)
                </label>
                <input type="number" name="pollIntervalSeconds" id="pollInterval"
                       min="30" max="86400" step="30"
                       th:value="${layer.syncConfig() != null ? layer.syncConfig().pollIntervalSeconds() : 300}"
                       class="w-full sm:w-48 rounded-lg border border-border bg-background px-3 py-2
                              text-sm text-foreground focus:border-primary focus:ring-1 focus:ring-primary">
                <p class="text-xs text-muted mt-1">Minimum 30s. Common values: 60 (1 min), 300 (5 min), 3600 (1 hr)</p>
            </div>

            <!-- Order by column -->
            <div>
                <label for="orderByColumn" class="block text-sm font-medium text-foreground mb-1.5">
                    Ordering Column <span class="text-muted font-normal">(optional)</span>
                </label>
                <input type="text" name="orderByColumn" id="orderByColumn"
                       placeholder="e.g. updated_at, id, created_at"
                       th:value="${layer.syncConfig() != null ? layer.syncConfig().orderByColumn() : ''}"
                       class="w-full sm:w-72 rounded-lg border border-border bg-background px-3 py-2
                              text-sm text-foreground placeholder:text-muted
                              focus:border-primary focus:ring-1 focus:ring-primary">
                <p class="text-xs text-muted mt-1">
                    A monotonically increasing column (timestamp or auto-increment) enables
                    <strong>incremental sync</strong> — only new rows are read each poll.
                    Without this, each poll does a full table scan with hash-based dedup.
                </p>
            </div>

            <div class="pt-2">
                <button type="submit"
                        class="rounded-lg bg-foreground px-4 py-2.5 text-sm font-medium text-background
                               hover:bg-foreground/90 transition-all">
                    Save Configuration
                </button>
            </div>
        </form>
    </div>

    <!-- Metadata cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">

        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Geometry Type</p>
            <p class="mt-1 text-lg font-semibold text-foreground" th:text="${layer.geometryType()}">POINT</p>
        </div>

        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Geometry Column</p>
            <p class="mt-1 text-lg font-semibold text-foreground" th:text="${layer.geometryColumn()}">geom</p>
        </div>

        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">SRID</p>
            <p class="mt-1 text-lg font-semibold text-foreground" th:text="${layer.srid()}">4326</p>
        </div>

        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Row Count</p>
            <p class="mt-1 text-lg font-semibold text-foreground"
               th:text="${layer.rowCount() >= 0} ? ${#numbers.formatInteger(layer.rowCount(), 1, 'COMMA')} : '—'">0</p>
        </div>

        <div class="bg-surface border border-border rounded-xl p-5 sm:col-span-2" th:if="${layer.extent() != null}">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Extent (Bounding Box)</p>
            <div class="mt-2 grid grid-cols-2 gap-x-6 gap-y-1 text-sm">
                <div>
                    <span class="text-muted">Min X:</span>
                    <span class="text-foreground ml-1" th:text="${#numbers.formatDecimal(layer.extent()[0], 1, 6)}">0</span>
                </div>
                <div>
                    <span class="text-muted">Max X:</span>
                    <span class="text-foreground ml-1" th:text="${#numbers.formatDecimal(layer.extent()[2], 1, 6)}">0</span>
                </div>
                <div>
                    <span class="text-muted">Min Y:</span>
                    <span class="text-foreground ml-1" th:text="${#numbers.formatDecimal(layer.extent()[1], 1, 6)}">0</span>
                </div>
                <div>
                    <span class="text-muted">Max Y:</span>
                    <span class="text-foreground ml-1" th:text="${#numbers.formatDecimal(layer.extent()[3], 1, 6)}">0</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Preview placeholder -->
    <div class="bg-surface border border-border rounded-xl p-6">
        <h2 class="text-lg font-semibold text-foreground mb-2">Preview</h2>
        <div class="py-8 text-center">
            <svg class="mx-auto h-10 w-10 text-muted mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9 6.75V15m6-6v8.25m.503 3.498 4.875-2.437c.381-.19.622-.58.622-1.006V4.82c0-.836-.88-1.38-1.628-1.006l-3.869 1.934c-.317.159-.69.159-1.006 0L9.503 3.252a1.125 1.125 0 0 0-1.006 0L3.622 5.689C3.24 5.88 3 6.27 3 6.695V19.18c0 .836.88 1.38 1.628 1.006l3.869-1.934c.317-.159.69-.159 1.006 0l4.994 2.497c.317.158.69.158 1.006 0Z"/>
            </svg>
            <p class="text-sm text-muted">Map preview and attribute schema coming soon.</p>
        </div>
    </div>

</th:block>

</body>
</html>