<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<body>

<th:block th:fragment="content">

    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-foreground">Live Streams</h1>
        <p class="mt-1 text-sm text-muted">Real-time feature delivery via SSE, WebSocket, and REST polling.</p>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-2 sm:grid-cols-5 gap-4 mb-8">
        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Active Connections</p>
            <p class="mt-1 text-2xl font-bold text-foreground" th:text="${stats.get('total')}">0</p>
        </div>
        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">SSE</p>
            <p class="mt-1 text-2xl font-bold text-foreground" th:text="${stats.get('sse')}">0</p>
        </div>
        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">WebSocket</p>
            <p class="mt-1 text-2xl font-bold text-foreground" th:text="${stats.get('websocket')}">0</p>
        </div>
        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">REST Poll</p>
            <p class="mt-1 text-2xl font-bold text-foreground" th:text="${stats.get('restPoll')}">0</p>
        </div>
        <div class="bg-surface border border-border rounded-xl p-5">
            <p class="text-xs font-medium text-muted uppercase tracking-wide">Total Delivered</p>
            <p class="mt-1 text-2xl font-bold text-foreground" th:text="${stats.get('totalDelivered')}">0</p>
        </div>
    </div>

    <!-- Endpoints reference -->
    <div class="mb-8 bg-surface border border-border rounded-xl p-5">
        <h2 class="text-sm font-semibold text-foreground mb-4">Connection Endpoints</h2>
        <div class="space-y-4">
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="inline-flex items-center rounded-md bg-primary/10 px-2 py-0.5 text-xs font-medium text-primary">SSE</span>
                    <code class="text-sm text-foreground">GET /tessera/api/stream/sse</code>
                </div>
                <p class="text-xs text-muted ml-14">
                    Server-Sent Events. Params: <code>sourceId</code>, <code>sourceTable</code>,
                    <code>minX/minY/maxX/maxY</code>, <code>since</code>
                </p>
            </div>
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="inline-flex items-center rounded-md bg-accent/10 px-2 py-0.5 text-xs font-medium text-accent">WS</span>
                    <code class="text-sm text-foreground">ws://host/tessera/ws/stream</code>
                </div>
                <p class="text-xs text-muted ml-14">
                    WebSocket. Send: <code>{"action":"subscribe", "sourceId":"...", "bbox":{...}}</code>
                </p>
            </div>
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <span class="inline-flex items-center rounded-md bg-success/10 px-2 py-0.5 text-xs font-medium text-success">REST</span>
                    <code class="text-sm text-foreground">GET /tessera/api/stream/poll</code>
                </div>
                <p class="text-xs text-muted ml-14">
                    Delta polling. Params: <code>since</code> (required), <code>sourceId</code>,
                    <code>sourceTable</code>, <code>minX/minY/maxX/maxY</code>, <code>limit</code>
                </p>
            </div>
        </div>
    </div>

    <!-- Active subscriptions table -->
    <div class="bg-surface border border-border rounded-xl overflow-hidden">
        <div class="px-5 py-4 border-b border-border">
            <h2 class="text-sm font-semibold text-foreground">Active Subscriptions</h2>
        </div>

        <div th:if="${#lists.isEmpty(subscriptions)}" class="px-5 py-12 text-center">
            <svg class="mx-auto h-10 w-10 text-muted mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9.348 14.651a3.75 3.75 0 010-5.303m5.304 0a3.75 3.75 0 010 5.303m-7.425 2.122a6.75 6.75 0 010-9.546m9.546 0a6.75 6.75 0 010 9.546M5.106 18.894c-3.808-3.808-3.808-9.98 0-13.789m13.788 0c3.808 3.808 3.808 9.981 0 13.79"/>
            </svg>
            <p class="text-sm text-muted">No active stream subscriptions.</p>
            <p class="text-xs text-muted mt-1">Connect via SSE, WebSocket, or REST to see live subscriptions here.</p>
        </div>

        <div th:if="${!#lists.isEmpty(subscriptions)}" class="overflow-x-auto">
            <table class="w-full text-sm">
                <thead>
                <tr class="border-b border-border text-left">
                    <th class="px-5 py-3 font-medium text-muted">ID</th>
                    <th class="px-5 py-3 font-medium text-muted">Protocol</th>
                    <th class="px-5 py-3 font-medium text-muted">Source</th>
                    <th class="px-5 py-3 font-medium text-muted">Spatial Filter</th>
                    <th class="px-5 py-3 font-medium text-muted">Cursor</th>
                    <th class="px-5 py-3 font-medium text-muted">Delivered</th>
                    <th class="px-5 py-3 font-medium text-muted">Connected</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="sub : ${subscriptions}" class="border-b border-border/50 hover:bg-background/50">
                    <td class="px-5 py-3 font-mono text-xs text-muted" th:text="${#strings.abbreviate(sub.id(), 12)}">abc...</td>
                    <td class="px-5 py-3">
                        <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium"
                              th:classappend="${sub.protocol().name() == 'SSE'} ? 'bg-primary/10 text-primary' :
                                              (${sub.protocol().name() == 'WEBSOCKET'} ? 'bg-accent/10 text-accent' : 'bg-success/10 text-success')"
                              th:text="${sub.protocol()}">SSE</span>
                    </td>
                    <td class="px-5 py-3 text-foreground" th:text="${sub.sourceId() != null ? sub.sourceId() : 'all'}">all</td>
                    <td class="px-5 py-3 text-foreground text-xs"
                        th:text="${sub.spatialFilter() != null ? sub.spatialFilter().toString() : 'global'}">global</td>
                    <td class="px-5 py-3 font-mono text-xs text-muted" th:text="${sub.cursor()}">—</td>
                    <td class="px-5 py-3 font-semibold text-foreground" th:text="${sub.deliveredCount()}">0</td>
                    <td class="px-5 py-3 text-xs text-muted" th:text="${sub.createdAt()}">—</td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

</th:block>

</body>
</html>